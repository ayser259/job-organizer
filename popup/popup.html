<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Save to Tracker</title>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <svg width="20" height="20" viewBox="0 0 100 100" fill="none">
          <path d="M6.017 4.313l55.333 -4.087c6.797 -0.583 8.543 -0.19 12.817 2.917l17.663 12.443c2.913 2.14 3.883 2.723 3.883 5.053v68.243c0 4.277 -1.553 6.807 -6.99 7.193L24.467 99.967c-4.08 0.193 -6.023 -0.39 -8.16 -3.113L3.3 79.94c-2.333 -3.113 -3.3 -5.443 -3.3 -8.167V11.113c0 -3.497 1.553 -6.413 6.017 -6.8z" fill="#fff"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M61.35 0.227l-55.333 4.087C1.553 4.7 0 7.617 0 11.113v60.66c0 2.723 0.967 5.053 3.3 8.167l13.007 16.913c2.137 2.723 4.08 3.307 8.16 3.113l64.257 -3.89c5.433 -0.387 6.99 -2.917 6.99 -7.193V20.64c0 -2.21 -0.873 -2.847 -3.443 -4.733L74.167 3.143c-4.273 -3.107 -6.02 -3.5 -12.817 -2.917zM25.92 19.523c-5.247 0.353 -6.437 0.433 -9.417 -1.99L8.927 11.507c-0.77 -0.78 -0.383 -1.753 1.557 -1.947l53.193 -3.887c4.467 -0.39 6.793 1.167 8.54 2.527l9.123 6.61c0.39 0.197 1.36 1.36 0.193 1.36l-54.933 3.307 -0.68 0.047zM19.803 88.3V30.367c0 -2.53 0.777 -3.697 3.103 -3.893L86 22.78c2.14 -0.193 3.107 1.167 3.107 3.693v57.547c0 2.53 -0.39 4.67 -3.883 4.863l-60.377 3.5c-3.493 0.193 -5.043 -0.97 -5.043 -4.083zm59.6 -54.827c0.387 1.75 0 3.5 -1.75 3.7l-2.91 0.577v42.773c-2.527 1.36 -4.853 2.137 -6.797 2.137 -3.107 0 -3.883 -0.973 -6.21 -3.887l-19.03 -29.94v28.967l6.02 1.363s0 3.5 -4.857 3.5l-13.39 0.777c-0.39 -0.78 0 -2.723 1.357 -3.11l3.497 -0.97v-38.3L30.48 40.667c-0.39 -1.75 0.58 -4.277 3.3 -4.473l14.367 -0.967 19.8 30.327v-26.83l-5.047 -0.58c-0.39 -2.143 1.163 -3.7 3.103 -3.89l13.4 -0.78z" fill="#000"/>
        </svg>
        <span>Save to Tracker</span>
      </div>
      <div class="header-actions">
        <button class="debug-btn hidden" id="debugBtn" title="View Extracted Content (Debug)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
        </button>
        <button class="refresh-btn hidden" id="refreshBtn" title="Refresh Schema">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
        </button>
        <button class="help-btn" id="helpBtn" title="Keyboard Shortcuts">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
        </button>
        <button class="settings-btn" id="settingsBtn" title="Settings">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Loading State -->
      <div class="state loading-state" id="loadingState">
        <div class="spinner"></div>
        <p>Loading database schema...</p>
      </div>

      <!-- Error State -->
      <div class="state error-state hidden" id="errorState">
        <div class="error-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <h3 class="error-title">Configuration Required</h3>
        <p class="error-message" id="errorMessage">Please configure your Notion credentials</p>
        <button class="btn btn-primary" id="configureBtn">Configure Extension</button>
      </div>

      <!-- Success State -->
      <div class="state success-state hidden" id="successState">
        <div class="success-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <h3>Page Created!</h3>
        <p class="success-message">Your entry has been saved to Notion</p>
        <a class="btn btn-primary" id="viewPageBtn" href="#" target="_blank">View in Notion</a>
        <button class="btn btn-secondary" id="addAnotherBtn">Add Another</button>
      </div>

      <!-- Form -->
      <form class="form hidden" id="clipperForm">
        <!-- AI Loading Overlay -->
        <div class="ai-loading-overlay hidden" id="aiLoadingOverlay">
          <div class="ai-loading-content">
            <div class="spinner"></div>
            <p>Analyzing content with AI...</p>
          </div>
        </div>
        
        <!-- Quick Save Button (Top) -->
        <div class="quick-save-container">
          <button class="ai-btn hidden" id="aiBtn" title="Add Details">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
              <circle cx="8" cy="14" r="1"/>
              <circle cx="16" cy="14" r="1"/>
            </svg>
            <span class="ai-btn-text">Add Details</span>
            <span class="ai-btn-loading hidden">
              <span class="spinner-tiny"></span>
            </span>
          </button>
          <button class="customize-btn" id="customizeBtn" title="Customize Fields">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
            <span>Customize</span>
          </button>
          <button type="submit" class="btn btn-primary btn-quick-save" id="quickSaveBtn">
            <span class="btn-text">Quick Save</span>
            <span class="btn-loading hidden">
              <span class="spinner-small"></span>
            </span>
          </button>
        </div>
        
        <div class="form-fields" id="formFields">
          <!-- Dynamic fields will be injected here -->
        </div>
        
        <!-- Hidden Fields Section -->
        <div class="hidden-fields-section hidden" id="hiddenFieldsSection">
          <button type="button" class="hidden-fields-toggle" id="hiddenFieldsToggle">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>Hidden Fields</span>
            <span class="hidden-count" id="hiddenCount">(0)</span>
          </button>
          <div class="hidden-fields-list hidden" id="hiddenFieldsList">
            <!-- Hidden fields will be listed here -->
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-submit" id="submitBtn">
            <span class="btn-text">Save to Notion</span>
            <span class="btn-loading hidden">
              <span class="spinner-small"></span>
              Saving...
            </span>
          </button>
        </div>
      </form>
    </main>

    <!-- Database Name Footer -->
    <footer class="footer hidden" id="footer">
      <span class="db-label">Database:</span>
      <span class="db-name" id="dbName"></span>
    </footer>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
      <span class="toast-icon"></span>
      <span class="toast-message"></span>
    </div>

    <!-- AI Input Modal -->
    <div class="ai-input-modal hidden" id="aiInputModal">
      <div class="modal-overlay" id="aiInputModalOverlay"></div>
      <div class="modal-content ai-input-content">
        <div class="modal-header">
          <h2>Paste Content for AI Analysis</h2>
          <button class="modal-close" id="aiInputModalClose">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <p class="modal-hint">Paste the text content you want to analyze. Only this text will be sent to the LLM.</p>
          <textarea 
            class="ai-input-textarea" 
            id="aiInputTextarea" 
            placeholder="Paste your content here...&#10;&#10;The AI will extract relevant information from this text and fill the form fields."
            rows="15"
          ></textarea>
          <div class="char-count">
            <span id="charCount">0</span> characters
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelAiInput">Cancel</button>
          <button class="btn btn-primary" id="submitAiInput">Analyze with AI</button>
        </div>
      </div>
    </div>

    <!-- Debug Modal -->
    <div class="debug-modal hidden" id="debugModal">
      <div class="modal-overlay" id="debugModalOverlay"></div>
      <div class="modal-content debug-content">
        <div class="modal-header">
          <h2>Extracted Page Content (Debug)</h2>
          <button class="modal-close" id="debugModalClose">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="debug-section">
            <h3>Title</h3>
            <pre class="debug-text" id="debugTitle"></pre>
          </div>
          <div class="debug-section">
            <h3>URL</h3>
            <pre class="debug-text" id="debugUrl"></pre>
          </div>
          <div class="debug-section">
            <h3>Description</h3>
            <pre class="debug-text" id="debugDescription"></pre>
          </div>
          <div class="debug-section">
            <h3>Content (<span id="debugContentLength">0</span> characters)</h3>
            <pre class="debug-text debug-content-full" id="debugContent"></pre>
          </div>
          <div class="debug-section" id="debugStructuredSection">
            <h3>Structured Data</h3>
            <pre class="debug-text" id="debugStructured"></pre>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="copyDebugBtn">Copy All</button>
          <button class="btn btn-primary" id="closeDebugBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- Customize Modal -->
    <div class="customize-modal hidden" id="customizeModal">
      <div class="modal-overlay" id="modalOverlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Customize Fields</h2>
          <button class="modal-close" id="modalClose">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <p class="modal-hint">Reorder fields with arrows and hide/show with the eye icon</p>
          <div class="customize-fields-list" id="customizeFieldsList">
            <!-- Fields will be listed here -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelCustomize">Cancel</button>
          <button class="btn btn-primary" id="saveCustomize">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal hidden" id="shortcutsModal">
      <div class="modal-overlay" id="shortcutsModalOverlay"></div>
      <div class="modal-content shortcuts-content">
        <div class="modal-header">
          <h2>Keyboard Shortcuts</h2>
          <button class="modal-close" id="shortcutsModalClose">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="shortcuts-list">
            <div class="shortcut-item">
              <div class="shortcut-action">Open Extension Popup</div>
              <div class="shortcut-keys" id="shortcut-open" aria-label="Keyboard shortcut">Control + Shift + L</div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-action">Add Details</div>
              <div class="shortcut-keys" id="shortcut-add-details" aria-label="Keyboard shortcut">Control + Shift + E</div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-action">Quick Save</div>
              <div class="shortcut-keys" id="shortcut-quick-save" aria-label="Keyboard shortcut">Control + Shift + Y</div>
            </div>
          </div>
          <p class="shortcuts-note">
            <strong>Assign shortcuts:</strong> Open <code>chrome://extensions/shortcuts</code>, find "Save to Tracker", 
            and set keys for each action. If they show "Not set", click and press your desired keys.
          </p>
          <p class="shortcuts-note">
            Shortcuts only work when this popup is already open. Open the popup first, then use the keys.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="closeShortcutsBtn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="popup.js"></script>
</body>
</html>

